# API-001 Implementation Progress

## 2026-02-03: US-001 - ShoppingListItem JSON:API Implementation

### What was implemented:
- Added AshJsonApi.Resource extension to ShoppingListItem resource
- Created nested routes under `/api/json/shopping_lists/:shopping_list_id/items`
- Implemented endpoints: GET (index), GET (show), POST (create), PATCH (update), DELETE (destroy)
- Added custom action routes: `/check`, `/uncheck`, `/toggle`
- Created `create_from_api` action that derives `account_id` from parent shopping list

### Key learnings:

1. **AshJsonApi nested routes**: Use `base "/parent/:parent_id/children"` pattern for DDD aggregate roots. The `derive_filter? true` option helps filter index results by route params.

2. **Action arguments from routes**: For nested POST routes, the parent ID from the URL is passed as an action argument. Use `argument :parent_id, :uuid` to capture it.

3. **Deriving attributes from parent**: When creating a child resource, you can derive the tenant (`account_id`) from the parent by:
   - Fetching the parent via domain code interface: `Domain.get_parent(id, opts)`
   - Using `Ash.Changeset.change_attribute(:account_id, parent.account_id)`
   - NEVER use `Ash.get/read/write` directly - always go through domain code interfaces

4. **Context in Ash changes**: The context parameter in `change fn changeset, context -> ...` is an `Ash.Resource.Change.Context` struct, NOT a map. Access fields via struct syntax `context.tenant`, not `context[:tenant]`.

5. **Relationship vs attribute management**: Use `manage_relationship/4` for actual relationships (belongs_to/has_many), use `change_attribute/3` for attribute fields like `account_id`.

6. **JSON:API PATCH requests**: All PATCH requests in JSON:API require a `data` payload with `type` and `id`, even for custom actions that don't accept any attributes.

7. **Multitenancy isolation**: Tenant-isolated resources return empty results (not 403) when accessing data outside the user's tenant. This is the expected behavior for attribute-based multitenancy.

8. **Test patterns for JSON:API**:
   - Use `put_req_header("accept", "application/vnd.api+json")`
   - Use `put_req_header("content-type", "application/vnd.api+json")` for POST/PATCH
   - JWT token via `Phoenix.Token.sign(Endpoint, "user auth", user.id)`
   - DELETE returns 200 with resource data by default in AshJsonApi

### Files changed:
- `lib/grocery_planner/shopping/shopping_list_item.ex` - Added AshJsonApi extension and create_from_api action
- `test/support/shopping_test_helpers.ex` - New test helpers for Shopping domain
- `test/grocery_planner_web/controllers/api/shopping_list_item_test.exs` - 14 behavioral API tests

### Next priorities (from API-001):
- US-003: InventoryEntry nested under GroceryItem
- US-006/US-007: MealPlan templates and voting endpoints

---

## 2026-02-03: US-002 - RecipeIngredient JSON:API Implementation

### What was implemented:
- Added AshJsonApi.Resource extension to RecipeIngredient resource
- Created nested routes under `/api/json/recipes/:recipe_id/ingredients`
- Implemented endpoints: GET (index), GET (show), POST (create), PATCH (update), DELETE (destroy)
- Created `create_from_api` action that derives `account_id` from parent recipe

### Key learnings:
1. **Pattern reuse**: The US-001 pattern for nested resources (ShoppingListItem) applied directly to RecipeIngredient with minimal changes
2. **grocery_item_id required**: RecipeIngredient requires a grocery_item_id association, unlike ShoppingListItem which has optional grocery_item linking
3. **Domain code interfaces**: Used `GroceryPlanner.Recipes.get_recipe/2` instead of direct Ash.get calls

### Files changed:
- `lib/grocery_planner/recipes/recipe_ingredient.ex` - Added AshJsonApi extension and create_from_api action
- `test/support/recipes_test_helpers.ex` - New test helpers for Recipes domain
- `test/grocery_planner_web/controllers/api/recipe_ingredient_test.exs` - 9 behavioral API tests

### Next priorities:
- US-006/US-007: MealPlan templates and voting endpoints

---

## 2026-02-03: US-003 - InventoryEntry Nested Routes Implementation

### What was implemented:
- Changed InventoryEntry from flat `/inventory_entries` to nested `/grocery_items/:grocery_item_id/inventory_entries`
- Implemented endpoints: GET (index), GET (show), POST (create), PATCH (update), DELETE (destroy)
- Created `list_by_grocery_item` read action with explicit filter for reliable filtering
- Created `create_from_api` action that derives `account_id` from parent grocery item

### Key learnings:

1. **derive_filter? unreliable**: The `derive_filter? true` option in AshJsonApi didn't filter by route params reliably. Solution: create a custom read action with explicit `filter expr(grocery_item_id == ^arg(:grocery_item_id))`.

2. **Create action policies**: Ash policies that use `relates_to_actor_via` fail for create actions with "Cannot use a filter to authorize a create" error. Solution: use `authorize_if always()` for create actions since the parent lookup already validates access.

3. **belongs_to public attribute**: For filtering to work on relationship foreign keys, the `belongs_to` must have `public? true`. Without this, filter attempts fail with "No such field" error.

4. **Duplicate attribute definitions**: Don't define both an explicit `attribute :foreign_key_id` AND a `belongs_to` relationship - the belongs_to creates the attribute automatically. Having both can cause confusion.

### Files changed:
- `lib/grocery_planner/inventory/inventory_entry.ex` - Changed routes to nested, added list_by_grocery_item and create_from_api actions, fixed policies
- `test/grocery_planner_web/controllers/api/inventory_entry_test.exs` - 11 behavioral API tests

### Next priorities:
- US-006/US-007: MealPlan templates and voting endpoints
